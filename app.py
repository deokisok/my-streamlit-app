import streamlit as st
import requests

# =========================
# í˜ì´ì§€ ì„¤ì •
# =========================
st.set_page_config(page_title="ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?", layout="centered")

# =========================
# TMDB ì„¤ì •
# =========================
GENRES = {
    "ì•¡ì…˜": 28,
    "ì½”ë¯¸ë””": 35,
    "ë“œë¼ë§ˆ": 18,
    "SF": 878,
    "ë¡œë§¨ìŠ¤": 10749,
    "íŒíƒ€ì§€": 14,
}
POSTER_BASE = "https://image.tmdb.org/t/p/w500"

def fetch_movies(api_key: str, genre_id: int, n: int = 5):
    url = "https://api.themoviedb.org/3/discover/movie"
    params = {
        "api_key": api_key,
        "with_genres": genre_id,
        "language": "ko-KR",
        "sort_by": "popularity.desc",
        "page": 1,
    }
    r = requests.get(url, params=params, timeout=15)
    r.raise_for_status()
    return r.json().get("results", [])[:n]

# =========================
# ë‹µë³€ â†’ ì¥ë¥´ ë¶„ì„
# =========================
def analyze_genre(ans):
    score = {k: 0 for k in GENRES.keys()}

    # Q1 ì—¬ê°€
    if ans["q1"] in ["ì§‘ì—ì„œ ì•„ë¬´ê²ƒë„ ì•ˆ í•˜ê¸°", "í˜¼ì ì¡°ìš©íˆ ì‰¬ê¸°"]:
        score["ë“œë¼ë§ˆ"] += 2; score["ë¡œë§¨ìŠ¤"] += 1
    elif ans["q1"] in ["ì¹œêµ¬ë“¤ê³¼ ìˆ˜ë‹¤", "ë³´ë“œê²Œì„/íŒŒí‹°"]:
        score["ì½”ë¯¸ë””"] += 2
    elif ans["q1"] in ["ì¦‰í¥ ì—¬í–‰", "ìƒˆë¡œìš´ ë™ë„¤ íƒë°©"]:
        score["ì•¡ì…˜"] += 1; score["íŒíƒ€ì§€"] += 1
    elif ans["q1"] in ["í˜¼ì ì·¨ë¯¸ ëª°ì…", "ì „ì‹œ/ì±…/ì˜í™”"]:
        score["SF"] += 2; score["ë“œë¼ë§ˆ"] += 1

    # Q2 ìŠ¤íŠ¸ë ˆìŠ¤
    if ans["q2"] in ["ìš´ë™ìœ¼ë¡œ í’€ê¸°", "ëª¸ì„ ë§ì´ ì›€ì§ì´ê¸°"]:
        score["ì•¡ì…˜"] += 2
    elif ans["q2"] in ["ì›ƒê¸´ ì˜ìƒ ë³´ê¸°", "ì¹œêµ¬ë‘ ìˆ˜ë‹¤"]:
        score["ì½”ë¯¸ë””"] += 2
    elif ans["q2"] in ["ê°ì • ì •ë¦¬", "í˜¼ì ìƒê°"]:
        score["ë“œë¼ë§ˆ"] += 2
    elif ans["q2"] in ["ë§›ìˆëŠ” ê±° ë¨¹ê¸°", "ì¹´í˜/ì‚°ì±…"]:
        score["ë¡œë§¨ìŠ¤"] += 1; score["ë“œë¼ë§ˆ"] += 1

    # Q3 ì˜í™” ì·¨í–¥
    if ans["q3"] == "ëˆˆê³¼ ê·€ê°€ ì¦ê±°ìš´ ì˜í™”":
        score["SF"] += 2; score["íŒíƒ€ì§€"] += 2
    elif ans["q3"] == "í˜„ì‹¤ì ì¸ ì´ì•¼ê¸°":
        score["ë“œë¼ë§ˆ"] += 3
    elif ans["q3"] == "ì•„ë¬´ ìƒê° ì—†ì´ ì›ƒê¸°ëŠ” ì˜í™”":
        score["ì½”ë¯¸ë””"] += 3
    elif ans["q3"] == "ê¸´ì¥ê° ë„˜ì¹˜ëŠ” ì „ê°œ":
        score["ì•¡ì…˜"] += 3
    elif ans["q3"] == "ì„¤ë ˆëŠ” ê°ì •":
        score["ë¡œë§¨ìŠ¤"] += 3

    # Q4 ì—¬í–‰ ìŠ¤íƒ€ì¼
    if ans["q4"] == "ê³„íš ë¹¡ë¹¡":
        score["SF"] += 1; score["ë“œë¼ë§ˆ"] += 1
    elif ans["q4"] == "ì¦‰í¥/ììœ ":
        score["ì½”ë¯¸ë””"] += 1; score["ì•¡ì…˜"] += 1
    elif ans["q4"] == "ì•¡í‹°ë¹„í‹° ìœ„ì£¼":
        score["ì•¡ì…˜"] += 2
    elif ans["q4"] == "íë§/ê°ì„±":
        score["ë¡œë§¨ìŠ¤"] += 2; score["ë“œë¼ë§ˆ"] += 1

    # Q5 ì„±í–¥
    if ans["q5"] == "ë¶„ìœ„ê¸° ë©”ì´ì»¤":
        score["ì½”ë¯¸ë””"] += 2
    elif ans["q5"] == "ë¦¬ë”í˜•":
        score["ì•¡ì…˜"] += 1; score["íŒíƒ€ì§€"] += 1
    elif ans["q5"] == "ê³µê°í˜•":
        score["ë“œë¼ë§ˆ"] += 2; score["ë¡œë§¨ìŠ¤"] += 1
    elif ans["q5"] == "ë…ë¦½í˜•":
        score["SF"] += 2

    return max(score.items(), key=lambda x: x[1])[0]

# =========================
# ì‚¬ì´ë“œë°”
# =========================
with st.sidebar:
    st.header("ğŸ”‘ TMDB API ì„¤ì •")
    tmdb_key = st.text_input("TMDB API Key", type="password")

# =========================
# UI
# =========================
st.title("ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?")
st.write("ì¡°ê¸ˆ ë” ì„¸ë¶„í™”ëœ ì§ˆë¬¸ìœ¼ë¡œ, ë‹¹ì‹ ì˜ ì˜í™” ì·¨í–¥ì„ ì•Œì•„ë³¼ê²Œìš” ğŸ¥ğŸ¿")
st.divider()

q1 = st.radio(
    "1ï¸âƒ£ ì£¼ë§ì— ê°€ì¥ ëŒë¦¬ëŠ” í™œë™ì€?",
    [
        "ì§‘ì—ì„œ ì•„ë¬´ê²ƒë„ ì•ˆ í•˜ê¸°",
        "í˜¼ì ì¡°ìš©íˆ ì‰¬ê¸°",
        "ì¹œêµ¬ë“¤ê³¼ ìˆ˜ë‹¤",
        "ë³´ë“œê²Œì„/íŒŒí‹°",
        "ì¦‰í¥ ì—¬í–‰",
        "ìƒˆë¡œìš´ ë™ë„¤ íƒë°©",
        "í˜¼ì ì·¨ë¯¸ ëª°ì…",
        "ì „ì‹œ/ì±…/ì˜í™”"
    ]
)

q2 = st.radio(
    "2ï¸âƒ£ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ í’€ ë•Œ ê°€ì¥ ê°€ê¹Œìš´ ë°©ë²•ì€?",
    [
        "í˜¼ì ìƒê° ì •ë¦¬",
        "ê°ì • ì •ë¦¬/ì¼ê¸°",
        "ì¹œêµ¬ë‘ ìˆ˜ë‹¤",
        "ì›ƒê¸´ ì˜ìƒ ë³´ê¸°",
        "ìš´ë™ìœ¼ë¡œ í’€ê¸°",
        "ëª¸ì„ ë§ì´ ì›€ì§ì´ê¸°",
        "ë§›ìˆëŠ” ê±° ë¨¹ê¸°",
        "ì¹´í˜ë‚˜ ì‚°ì±…"
    ]
)

q3 = st.radio(
    "3ï¸âƒ£ ì˜í™”ë¥¼ ê³ ë¥¼ ë•Œ ê°€ì¥ ì¤‘ìš”í•œ í¬ì¸íŠ¸ëŠ”?",
    [
        "í˜„ì‹¤ì ì¸ ì´ì•¼ê¸°",
        "ê°ì • ëª°ì…",
        "ì„¤ë ˆëŠ” ê°ì •",
        "ì•„ë¬´ ìƒê° ì—†ì´ ì›ƒê¹€",
        "ê¸´ì¥ê° ë„˜ì¹˜ëŠ” ì „ê°œ",
        "ëˆˆê³¼ ê·€ê°€ ì¦ê±°ìš´ ì˜í™”"
    ]
)

q4 = st.radio(
    "4ï¸âƒ£ ì—¬í–‰ì„ ê°„ë‹¤ë©´ ë‚˜ëŠ”?",
    [
        "ê³„íš ë¹¡ë¹¡í•˜ê²Œ",
        "ì¼ì •ì€ ëŒ€ì¶©",
        "ì¦‰í¥/ììœ ",
        "ì•¡í‹°ë¹„í‹° ìœ„ì£¼",
        "íë§/ê°ì„± ì—¬í–‰"
    ]
)

q5 = st.radio(
    "5ï¸âƒ£ ì¹œêµ¬ë“¤ ì‚¬ì´ì—ì„œ ë‚˜ëŠ”?",
    [
        "ë¶„ìœ„ê¸° ë©”ì´ì»¤",
        "ë¦¬ë”í˜•",
        "ê³µê°í˜•",
        "ë…ë¦½í˜•",
        "í•„ìš”í•  ë•Œ ë‚˜íƒ€ë‚˜ëŠ” íƒ€ì…"
    ]
)

st.divider()

if st.button("ğŸï¸ ê²°ê³¼ ë³´ê¸°"):
    if not tmdb_key:
        st.error("TMDB API Keyë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”!")
        st.stop()

    answers = {"q1": q1, "q2": q2, "q3": q3, "q4": q4, "q5": q5}
    genre = analyze_genre(answers)
    genre_id = GENRES[genre]

    st.subheader(f"âœ¨ ë‹¹ì‹ ê³¼ ì–´ìš¸ë¦¬ëŠ” ì¥ë¥´ëŠ” **{genre}**")
    st.write("ì´ì œ ë‹¹ì‹ ì˜ ì·¨í–¥ê³¼ ë§ëŠ” ì¸ê¸° ì˜í™”ë¥¼ ë³´ì—¬ë“œë¦´ê²Œìš” ğŸ¿")

    movies = fetch_movies(tmdb_key, genre_id)

    for m in movies:
        cols = st.columns([1, 2])
        with cols[0]:
            if m.get("poster_path"):
                st.image(POSTER_BASE + m["poster_path"], use_container_width=True)
        with cols[1]:
            st.markdown(f"### {m.get('title')}")
            st.write(f"â­ í‰ì : {m.get('vote_average')}")
            st.write(m.get("overview", "ì¤„ê±°ë¦¬ ì •ë³´ê°€ ì—†ì–´ìš”."))
            st.caption("ğŸ’¡ ì¶”ì²œ ì´ìœ : ë‹¹ì‹ ì˜ ë‹µë³€ì´ ì´ ì¥ë¥´ì™€ ì˜ ë§ì•„ìš”.")

        st.divider()
